
<!-- Post Layout Start -->

<!DOCTYPE html>
<html lang="zh">

  
<!-- HEAD Start -->

<head>
  


  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Blog and website of Leon Sun">
  <meta name="author" content="Leon Sun">
  <meta name="keywords" content="Leon, IC, physical design">
  <link rel="canonical" href="/how-to-pass-formal-check/">
  <title>Leon Sun | How to pass formal check</title>
  <link rel="icon" type="image/png" href="/img/cpu.png">

  <!-- Bootstrap Core CSS -->
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"> -->
  <link rel="stylesheet" href="/css/bootstrap-3.3.5.min.css">

  <!-- Custom CSS -->
  <link href="/css/grayscale.css" rel="stylesheet">

  <!-- Custom Fonts -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Courgette" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/rrssb.css" >
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

  

  


  <!-- iOS Web App mode -->

  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" sizes="36x36" href="/img/web-app/icon-36p.png">
  <link rel="apple-touch-icon" sizes="48x48" href="/img/web-app/icon-48p.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/img/web-app/icon-72p.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/img/web-app/icon-96p.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/img/web-app/icon-144p.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/img/web-app/icon-192p.png">

  <!-- Android Web App mode -->

  <link rel="manifest" href="/manifest.json">




  
<!-- Chrome, Firefox OS and Opera -->
<meta name="theme-color" content="#000000">
<!-- <meta name="theme-color" content="#ffffff"> -->
<!-- Windows Phone -->
<meta name="msapplication-navbutton-color" content="#000000">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">


  


  <!-- Syntax highlight in post pages -->

  <!-- <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-light.min.css"> -->
  <link rel="stylesheet" type="text/css" href="/css/solarized-light.css">
  <!-- <link rel="stylesheet" type="text/css" href="/css/prism.css"> -->




</head>

<!-- HEAD End -->


  <body style="background-color: #F5F5F5">
	<!-- Sticky Footer to make footer at page bottom 2017/08/03 -->	
	<div id="content">
		
<!-- Navigation Start -->

<nav class="navbar navbar-custom navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse">
        <i class="fa fa-bars"></i>
      </button>
      
        <a class="navbar-brand" href="/">
      
          <div>
            
              <img src="/img/cpu.png" alt="">
            
            Leon Sun
          </div>
        </a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse navbar-right navbar-main-collapse">
      <ul class="nav navbar-nav">
          
            <li>
				<a class="page-scroll" href="/"> Home </a>
            </li>
          
            <li>
				<a class="page-scroll" href="/blogs"> Blog </a>
            </li>
          
            <li>
				<a class="page-scroll" href="/about"> About </a>
            </li>
          
      </ul>
    </div>
  </div>
</nav>

<!-- Navigation End -->

		<section id="post" class="container content-section text-center" style="display: block;background-color: white;">
			<div class="row">
				<div class="col-md-10 col-md-offset-1">
            		<h1><strong>How to pass formal check</strong></h1>
		    		<h5>
		    		<ul class="list-inline">
						<!--  -->
						
						<li><a href="/year/2017"> <i class="fa fa-calendar" aria-hidden="true" style="letter-spacing:-1px">2017/08/23</i></a></li>
						
							<li><a href="/category/tool"><i class="fa fa-folder-open" aria-hidden="true">tool</i></a></li>
						
						<!-- <li><a href="#todo"><i class="fa fa-comments" aria-hidden="true">#comments</i></a></li> -->
						
							<li><a href="/tag/formality"><i class="fa fa-tags" aria-hidden="true">formality</i></a></li>
						
							<li><a href="/tag/verification"><i class="fa fa-tags" aria-hidden="true">verification</i></a></li>
						
		    		</ul>
		    		</h5>
		    		<hr style="border-color: green;border-width: 2px;">
            		<section class="text-justify">
						<!-- <h2 id="formality">Formality</h2>
<blockquote>
  <p>Formality® is an equivalence-checking (EC) solution that uses formal, static techniques to determine if two versions of a design are functionally equivalent.</p>
</blockquote>

<p>Formality是Synopsys家的LEC工具，是IC设计中常用的工具之一。后端设计中，一般要做两次formality check:</p>
<ol>
  <li>综合后，RTL VS synthesis gate-level netlist.</li>
  <li>PR后，synthesis netlist VS PR netlist.</li>
</ol>

<p><img src="/img/2017-08-21_111804.png" alt="formality check in physical design" title="formality check in physical design" /></p>

<p>DC综合时，涉及designware mapping, retiming optimize, regisiter add/removal等复杂的逻辑操作，导致RLT-gate formality check会比较棘手，虽然DC会产生SVF( Setup Verification for Formality),但是由于设计复杂性，仍然会产生各种意想不到的fail/hard verification.
PR中，由于涉及到的逻辑优化较简单，一般不难pass formality;如果涉及复杂优化，如add/spilt multibit bank等复杂逻辑操作，也许需要生成svf来辅助formality check.</p>
<blockquote>
  <p>SVF:
 Setup Verification for Formality, 记录优化过程中的各项逻辑操作，比如replace, merge, uniquify, retime, reg_constant等等，是用于辅助formality verification的。DC产生的不可读svf可以在formality内转成可读文本。</p>
</blockquote>

<h2 id="rtl-vs-gate">RTL VS GATE</h2>
<p>如果综合后，RTL-Gate formality fail/inconclusive,该如何debug呢？
Formality debug 可以有logic cone, failing pattern, analyze_point, alternative strategy 等。</p>
<h3 id="fail">Fail</h3>
<p>Formality fail 通常有以下几种情况：</p>
<ol>
  <li>miss constraint
 这种情况下，一般容易从pattern里发现。如果failing pattern里某个pin的值都是相同的，比如failing point 的input pin SE 都是1，则很可能是由于做function formality时 scan enable port 没有设为constant value.</li>
  <li>datapath
 这里的datapath不是指STA里的data/clk path, 而是加减乘除之内的逻辑运算。这些逻辑 运算可以自己rtl实现，也可以直接例化S家的designware。对于同一个逻辑运算，比如3位乘以5位的乘法器，底层实现可能有多种方式。为了实现timing, S家的大部分designware,如div/multi/div_pipe/multi_pipe等都内置retime属性，在compile时会根据design来做retime 优化。前面也说过，retime属于复杂操作，容易引起fail verification.
主要的处理办法有以下几种：</li>
</ol>

<ul>
  <li>DC里对整个design 设置<code>simplified_verification_mode</code>，其实就是设置下面的参数:
    <blockquote>
      <p>The tool sets the value for the following  environment  variables  when the  simplified_verification_mode variable is set to true regardless of the value you specify:</p>

      <p>compile_ultra_ungroup_dw = false</p>

      <p>compile_clock_gating_through_hierarchy = false</p>

      <p>hdlin_verification_priority = true</p>
    </blockquote>
  </li>
  <li>在DC里使用<code>set_verification_priority</code> 来告诉DC某个cell/design，要verification优先，不要优化地太狠，不要ungroup。但是verification_priority attribute不会传到subdesign.</li>
  <li>分两步综合，首先对相关design设dont_retime，compile后,再对design 用optimize_register 做Retime 优化。</li>
  <li>前面的法都是goabl方法，虽然简单，但是个人发现通常效果并不好,这样的话就要具体问题具分析。
利用<code>analyze_points</code> 对failing point分析，通常formality会给出fail reason 和recommendtion. Fail reason 通常会是某些相关的svf operation 被formality rejected.常见的有guide_reg_constant,guide_replace，guide_change_name之类。然后可以用<code>report_svf_operation -command * -status rejected</code> 来查看具体是为啥这个svf operation 被formality rejected。比如经常出现的是formality找不到某些pin/cell,这时候就要确认原因，是因为name mismatch 还是真的不存在，不存在的情况多为DC默认会把redundant cell/constant register 删除掉，也许它是为了area考虑，结果导致了formality fail。确定起因后，就要在DC 里work-around 来避免这个问题发生。</li>
</ul>

<h3 id="inconclusive">Inconclusive</h3>

<p>Inconclusive 一般由于逻辑太复杂，logic cone 太大，导致formality长时间比较后仍然得不出结论。一般解决方法有:</p>
<ul>
  <li>换更新的formality版本，花钱消灾…</li>
  <li>加大timeout limit: <code>verification_timeout_limit</code>, 0 为no limit;</li>
  <li>设高datapath effort：<code>verification_datapath_effort_level</code>；</li>
  <li>使用alternate strategy：formality内置其它多种不同算法来比较hard verification,需要挨个尝试，可能全部试过多没用，自求多福…
    <blockquote>
      <p>verification_alternate_strategy specifies that verification uses a nonstandard strategy for solving hard verifications.</p>

      <p>The order of the list indicates which strategy to use first:</p>

      <p>none s2 s3 s1 l2 s10 s8 l1 l3 s4 s6 s5 k1 k2 s7 s9</p>
    </blockquote>
  </li>
  <li>DC里相关design设置verification优先，降低opt effort；</li>
  <li>DC先compile hard_verification design, 再compile other designs.</li>
</ul>

<h2 id="project-cases">Project Cases</h2>
<h3 id="case-1">Case 1</h3>
<h4 id="11-problem">1.1 Problem</h4>
<p>综合后，formality fail，有73个failing points，这些points都属于两个module，随便选取一个points:
u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/U_DIV/bdramclk1x_r_REG42_S1
其余failing points的命名也类似，从这些reg的名字可以看出它们都是做了retime优化的（DC retime的默认命名**REG**_S*).</p>
<h4 id="12-debug">1.2 Debug</h4>
<p>打开logic cone， 如下图,发现failing points是SD/AD, 在Imp里是constant0; 而Ref里它们是从fm_bb出来，fm_bb 是formality black box，bbox 的input被formality认为loginc cone 的endpoint, output 被认为是logic cone的startpoint,因为不知内部逻辑，其output作为logic cone的startpoint时可以为0/1/X。</p>

<p><img src="/img/logic_cone.png" alt="logic cone" title="logic cone" /></p>

<p>analyze_points 对这个点分析：</p>
<pre><code>fm_shell (verify)&gt; analyze_points r:/WORK/wp45/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/fm_ret_fwmc_1_1_323/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/U_DIV/bdramclk1x_r_REG42_S1
Found 2 Unmatched Cone Inputs
--------------------------------
Unmatched cone inputs result either from mismatched compare points
or from differences in the logic within the cones. Only unmatched
inputs that are suspected of contributing to verification failures
are included in the report.
The source of the matching or logical differences may be determined
using the schematic, cone and source views.
--------------------------------
r:/WORK/wp45/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/clk_gate_a_int_reg[1]/latch/\*lat.00\*
    Is globally unmatched affecting 1 compare point(s):
        i:/WORK/wp45/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/fm_ret_fwmc_1_1_323/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/U_DIV/bdramclk1x_r_REG42_S1

-----------
r:/WORK/wp45/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/fm_ret_fwmc_1_1_323/fm_bb/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/a_int_reg[3][0]
    Matched with pin i:/WORK/wp45/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/fm_ret_fwmc_1_1_323/fm_bb/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/a_int_reg[3][0]
    Exists in the ref cone but not in the impl cone for 1 compare point(s):
        i:/WORK/wp45/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/fm_ret_fwmc_1_1_323/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/U_DIV/bdramclk1x_r_REG42_S1

-----------
--------------------------------
Found 1 Rejected Guidance Command
--------------------------------
The rejection of some SVF guidance commands will almost invariably
cause verification failures. For more information use:
        report_svf_operation -status rejected -command command_name
--------------------------------
reg_constant
-----------
--------------------------------
****************************************************************************************
Analysis Completed
1

</code></pre>
<p>分析report,首先logic cone 有两个unmatched inputs：一个是gating, 但是发现这个gating并不影响func,而且ref/imp reg的CK 都是r,所以这个gating并不是导致failing points的原因；另一个是fm_bb，这个存在于ref里，也正是由于这个fm_bb的output是1才导致SD/AD pin fail。
接着，有一个guidance cmd 被rejected：guide_reg_constant，这是svf里把reg标为constant 0/1 的操作。联想到imp里SD/AD pin的startpoints 都是constant 0, 所以应该是DC做reg_constant 操作，将failing point 前的reg 标为0，但是这个操作因为某种原因被formality rejected, 从而ref 里引入了fm_bb。那么到底是为何被reject? report_svf_operation report 截取一段如下：</p>
<pre><code>## SVF Operation 945483 (Line: 8463522) - reg_constant.  Status: rejected
## Operation Id: 945483
guide_reg_constant \
  -design { wp45 } \
  -replaced { svfTrue } \
  { u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm3/u_mult_0/mult_x_1/bimeclk_r_REG123_S1 } \
  { 0 } 

Info:  guide_reg_constant 945483 (Line: 8463522) Cannot find master reference cell 'u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm3/u_mult_0/mult_x_1/bimeclk_r_REG123_S1'.

</code></pre>
<p>原因就是：<strong>cannot find master reference cell</strong>。居然没有这个cell?那它又是哪来的？查找svf file，发现：</p>
<pre><code>## Operation Id: 875794
guide_retiming \
  -design { wp45 } \
  -direction { forward } \
  -libCell { FM_FORK } \
  -input { :__tmp__name___1392479 } \
  -output { :u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm3/u_mult_0/mult_x_1/bimeclk_r_REG123_S1 } 

## Operation Id: 945483
guide_reg_constant \
  -design { wp45 } \
  -replaced { svfTrue } \
  { u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm3/u_mult_0/mult_x_1/bimeclk_r_REG123_S1 } \
  { 0 } 

</code></pre>
<p>这个reg是经过forward retime后命名为此，随后DC觉得它是个constant 0 reg。constant0 reg可能是因为D pin tie 0,也可能是reset pin tie 1 导致的。那么DC是怎么处理这些constant register 的呢？查找DC log,发现如下信息：</p>
<pre><code>Information: The register 'u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm3/u_mult_0/mult_x_1/bimeclk_r_REG123_S1' is a constant and will be removed. (OPT-1206)
Information: The register 'u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm2/u_mult_0/mult_x_1/bimeclk_r_REG123_S1' is a constant and will be removed. (OPT-1206)
Information: The register 'u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm1/u_mult_0/mult_x_1/bimeclk_r_REG123_S1' is a constant and will be removed. (OPT-1206)
Information: The register 'u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm0/u_mult_0/mult_x_1/bimeclk_r_REG123_S1' is a constant and will be removed. (OPT-1206)
</code></pre>
<p>真相大白：<strong>默认情况下，DC会remove constant register, 并在log里给出OPT-1206提示</strong>。至此，终于找到failing root cause,下面就是针对问题找到解决方法了。DC 对constant register 的处理由以下3个变量控制，默认值都是true:</p>
<pre><code>compile_seqmap_propagate_constants:           Removes cells with a constant on the input.
compile_seqmap_propagate_high_effort:         Removes cells with a constant on the reset.
compile_seqmap_propagate_constants_size_only: Propagates constants through size_only cells.
</code></pre>
<p>其中，<code>compile_seqmap_propagate_constants_size_only</code> 是控制是否传递size_only/dont_touch attribute的constant reg 的constant value，而不是要remove size_only/dont_touch reg。</p>

<h4 id="13-slove">1.3 Slove</h4>
<p>所以，我们在compile前将这些变量设为false,问题应该就可以迎刃而解了。但是，难道我们要用没有remove constant reg的netlist做PR? 好吧，曲线救国：</p>
<ol>
  <li>set var flase, RTL—&gt; netlist1</li>
  <li>set var true,   RTL—&gt; netlist 2</li>
  <li>formality, RTL VS netlist1</li>
  <li>formality, netlist1 VS netlist2</li>
  <li>PR with netlist2</li>
</ol>

<h3 id="case2">Case2</h3>
<h4 id="21-problem">2.1 Problem</h4>
<p>综合完，RTL-Gate Formality inconclusive, 有33个points。原来这个module属于一个42bit除以9bit的除法器，每一位quotient的logic cone都很大，formality 很难比较。</p>
<pre><code>********************************* Verification Results *********************************
Verification INCONCLUSIVE
(Equivalence checking aborted due to complexity)
   ATTENTION: synopsys_auto_setup mode was enabled.
              See Synopsys Auto Setup Summary for details.
   ATTENTION: RTL interpretation messages were produced during link
              of reference design.
              Verification results may disagree with a logic simulator.
-----------------------------------------------------------------------
 Reference design: r:/WORK/***
 Implementation design: i:/WORK/***
 161129 Passing compare points
 33 Aborted compare points
 0 Unverified compare points
</code></pre>
<h4 id="22-debug">2.2 Debug</h4>
<p>前文提到的方法我都一一试过:timeout-limit, datapath-effort, new tool version, set_verification_priority, 10多种alternative strategy 都没用……
难道真的是因为这个42bit/9bit 的除法器太大了，无论如何都无法过formality?
那么仅综合这个除法器能不能过呢？我尝试把这个除法器module摘出来，仅综合这个module，然后对这个module做formal check,奇迹出现了，居然SUCCESSED.</p>
<h4 id="23-solve">2.3 Solve</h4>
<p>最终，通过优先综合除法器design，再综合其它design, 才成功pass formal check.</p>

<h2 id="conclusion">Conclusion</h2>
<p>RTL-Gate LEC check 是一项很复杂的过程，通常需要在DC/formality里迭代完成，这是非常耗时的，所以formal check 的经验在此格外重要，大牛可能一眼就看出是什么原因，需要在综合时做何种设置；而吾类菜鸟就要慢慢debug,花费大量时间尝试各种可能。文中所述仅为本人在项目中积累的粗浅经验，有错请指正。<strong>不积跬步无以至千里</strong>，不断积累，早日成大牛!</p>

 -->
            		  <h2 id="formality">Formality</h2>
<blockquote>
  <p>Formality® is an equivalence-checking (EC) solution that uses formal, static techniques to determine if two versions of a design are functionally equivalent.</p>
</blockquote>

<p>Formality是Synopsys家的LEC工具，是IC设计中常用的工具之一。后端设计中，一般要做两次formality check:</p>
<ol>
  <li>综合后，RTL VS synthesis gate-level netlist.</li>
  <li>PR后，synthesis netlist VS PR netlist.</li>
</ol>

<p><img src="/img/2017-08-21_111804.png" alt="formality check in physical design" title="formality check in physical design" /></p>

<p>DC综合时，涉及designware mapping, retiming optimize, regisiter add/removal等复杂的逻辑操作，导致RLT-gate formality check会比较棘手，虽然DC会产生SVF( Setup Verification for Formality),但是由于设计复杂性，仍然会产生各种意想不到的fail/hard verification.
PR中，由于涉及到的逻辑优化较简单，一般不难pass formality;如果涉及复杂优化，如add/spilt multibit bank等复杂逻辑操作，也许需要生成svf来辅助formality check.</p>
<blockquote>
  <p>SVF:
 Setup Verification for Formality, 记录优化过程中的各项逻辑操作，比如replace, merge, uniquify, retime, reg_constant等等，是用于辅助formality verification的。DC产生的不可读svf可以在formality内转成可读文本。</p>
</blockquote>

<h2 id="rtl-vs-gate">RTL VS GATE</h2>
<p>如果综合后，RTL-Gate formality fail/inconclusive,该如何debug呢？
Formality debug 可以有logic cone, failing pattern, analyze_point, alternative strategy 等。</p>
<h3 id="fail">Fail</h3>
<p>Formality fail 通常有以下几种情况：</p>
<ol>
  <li>miss constraint
 这种情况下，一般容易从pattern里发现。如果failing pattern里某个pin的值都是相同的，比如failing point 的input pin SE 都是1，则很可能是由于做function formality时 scan enable port 没有设为constant value.</li>
  <li>datapath
 这里的datapath不是指STA里的data/clk path, 而是加减乘除之内的逻辑运算。这些逻辑 运算可以自己rtl实现，也可以直接例化S家的designware。对于同一个逻辑运算，比如3位乘以5位的乘法器，底层实现可能有多种方式。为了实现timing, S家的大部分designware,如div/multi/div_pipe/multi_pipe等都内置retime属性，在compile时会根据design来做retime 优化。前面也说过，retime属于复杂操作，容易引起fail verification.
主要的处理办法有以下几种：</li>
</ol>

<ul>
  <li>DC里对整个design 设置<code>simplified_verification_mode</code>，其实就是设置下面的参数:
    <blockquote>
      <p>The tool sets the value for the following  environment  variables  when the  simplified_verification_mode variable is set to true regardless of the value you specify:</p>

      <p>compile_ultra_ungroup_dw = false</p>

      <p>compile_clock_gating_through_hierarchy = false</p>

      <p>hdlin_verification_priority = true</p>
    </blockquote>
  </li>
  <li>在DC里使用<code>set_verification_priority</code> 来告诉DC某个cell/design，要verification优先，不要优化地太狠，不要ungroup。但是verification_priority attribute不会传到subdesign.</li>
  <li>分两步综合，首先对相关design设dont_retime，compile后,再对design 用optimize_register 做Retime 优化。</li>
  <li>前面的法都是goabl方法，虽然简单，但是个人发现通常效果并不好,这样的话就要具体问题具分析。
利用<code>analyze_points</code> 对failing point分析，通常formality会给出fail reason 和recommendtion. Fail reason 通常会是某些相关的svf operation 被formality rejected.常见的有guide_reg_constant,guide_replace，guide_change_name之类。然后可以用<code>report_svf_operation -command * -status rejected</code> 来查看具体是为啥这个svf operation 被formality rejected。比如经常出现的是formality找不到某些pin/cell,这时候就要确认原因，是因为name mismatch 还是真的不存在，不存在的情况多为DC默认会把redundant cell/constant register 删除掉，也许它是为了area考虑，结果导致了formality fail。确定起因后，就要在DC 里work-around 来避免这个问题发生。</li>
</ul>

<h3 id="inconclusive">Inconclusive</h3>

<p>Inconclusive 一般由于逻辑太复杂，logic cone 太大，导致formality长时间比较后仍然得不出结论。一般解决方法有:</p>
<ul>
  <li>换更新的formality版本，花钱消灾…</li>
  <li>加大timeout limit: <code>verification_timeout_limit</code>, 0 为no limit;</li>
  <li>设高datapath effort：<code>verification_datapath_effort_level</code>；</li>
  <li>使用alternate strategy：formality内置其它多种不同算法来比较hard verification,需要挨个尝试，可能全部试过多没用，自求多福…
    <blockquote>
      <p>verification_alternate_strategy specifies that verification uses a nonstandard strategy for solving hard verifications.</p>

      <p>The order of the list indicates which strategy to use first:</p>

      <p>none s2 s3 s1 l2 s10 s8 l1 l3 s4 s6 s5 k1 k2 s7 s9</p>
    </blockquote>
  </li>
  <li>DC里相关design设置verification优先，降低opt effort；</li>
  <li>DC先compile hard_verification design, 再compile other designs.</li>
</ul>

<h2 id="project-cases">Project Cases</h2>
<h3 id="case-1">Case 1</h3>
<h4 id="11-problem">1.1 Problem</h4>
<p>综合后，formality fail，有73个failing points，这些points都属于两个module，随便选取一个points:
u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/U_DIV/bdramclk1x_r_REG42_S1
其余failing points的命名也类似，从这些reg的名字可以看出它们都是做了retime优化的（DC retime的默认命名**REG**_S*).</p>
<h4 id="12-debug">1.2 Debug</h4>
<p>打开logic cone， 如下图,发现failing points是SD/AD, 在Imp里是constant0; 而Ref里它们是从fm_bb出来，fm_bb 是formality black box，bbox 的input被formality认为loginc cone 的endpoint, output 被认为是logic cone的startpoint,因为不知内部逻辑，其output作为logic cone的startpoint时可以为0/1/X。</p>

<p><img src="/img/logic_cone.png" alt="logic cone" title="logic cone" /></p>

<p>analyze_points 对这个点分析：</p>
<pre><code>fm_shell (verify)&gt; analyze_points r:/WORK/wp45/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/fm_ret_fwmc_1_1_323/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/U_DIV/bdramclk1x_r_REG42_S1
Found 2 Unmatched Cone Inputs
--------------------------------
Unmatched cone inputs result either from mismatched compare points
or from differences in the logic within the cones. Only unmatched
inputs that are suspected of contributing to verification failures
are included in the report.
The source of the matching or logical differences may be determined
using the schematic, cone and source views.
--------------------------------
r:/WORK/wp45/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/clk_gate_a_int_reg[1]/latch/\*lat.00\*
    Is globally unmatched affecting 1 compare point(s):
        i:/WORK/wp45/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/fm_ret_fwmc_1_1_323/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/U_DIV/bdramclk1x_r_REG42_S1

-----------
r:/WORK/wp45/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/fm_ret_fwmc_1_1_323/fm_bb/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/a_int_reg[3][0]
    Matched with pin i:/WORK/wp45/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/fm_ret_fwmc_1_1_323/fm_bb/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/a_int_reg[3][0]
    Exists in the ref cone but not in the impl cone for 1 compare point(s):
        i:/WORK/wp45/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/fm_ret_fwmc_1_1_323/u_disptop/U_DISPD_LAI053/u_pnlmemctl/u_imgmemctl/u_abc4x4_dec/prl_ari_0__u_div/U_DIV/bdramclk1x_r_REG42_S1

-----------
--------------------------------
Found 1 Rejected Guidance Command
--------------------------------
The rejection of some SVF guidance commands will almost invariably
cause verification failures. For more information use:
        report_svf_operation -status rejected -command command_name
--------------------------------
reg_constant
-----------
--------------------------------
****************************************************************************************
Analysis Completed
1

</code></pre>
<p>分析report,首先logic cone 有两个unmatched inputs：一个是gating, 但是发现这个gating并不影响func,而且ref/imp reg的CK 都是r,所以这个gating并不是导致failing points的原因；另一个是fm_bb，这个存在于ref里，也正是由于这个fm_bb的output是1才导致SD/AD pin fail。
接着，有一个guidance cmd 被rejected：guide_reg_constant，这是svf里把reg标为constant 0/1 的操作。联想到imp里SD/AD pin的startpoints 都是constant 0, 所以应该是DC做reg_constant 操作，将failing point 前的reg 标为0，但是这个操作因为某种原因被formality rejected, 从而ref 里引入了fm_bb。那么到底是为何被reject? report_svf_operation report 截取一段如下：</p>
<pre><code>## SVF Operation 945483 (Line: 8463522) - reg_constant.  Status: rejected
## Operation Id: 945483
guide_reg_constant \
  -design { wp45 } \
  -replaced { svfTrue } \
  { u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm3/u_mult_0/mult_x_1/bimeclk_r_REG123_S1 } \
  { 0 } 

Info:  guide_reg_constant 945483 (Line: 8463522) Cannot find master reference cell 'u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm3/u_mult_0/mult_x_1/bimeclk_r_REG123_S1'.

</code></pre>
<p>原因就是：<strong>cannot find master reference cell</strong>。居然没有这个cell?那它又是哪来的？查找svf file，发现：</p>
<pre><code>## Operation Id: 875794
guide_retiming \
  -design { wp45 } \
  -direction { forward } \
  -libCell { FM_FORK } \
  -input { :__tmp__name___1392479 } \
  -output { :u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm3/u_mult_0/mult_x_1/bimeclk_r_REG123_S1 } 

## Operation Id: 945483
guide_reg_constant \
  -design { wp45 } \
  -replaced { svfTrue } \
  { u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm3/u_mult_0/mult_x_1/bimeclk_r_REG123_S1 } \
  { 0 } 

</code></pre>
<p>这个reg是经过forward retime后命名为此，随后DC觉得它是个constant 0 reg。constant0 reg可能是因为D pin tie 0,也可能是reset pin tie 1 导致的。那么DC是怎么处理这些constant register 的呢？查找DC log,发现如下信息：</p>
<pre><code>Information: The register 'u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm3/u_mult_0/mult_x_1/bimeclk_r_REG123_S1' is a constant and will be removed. (OPT-1206)
Information: The register 'u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm2/u_mult_0/mult_x_1/bimeclk_r_REG123_S1' is a constant and will be removed. (OPT-1206)
Information: The register 'u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm1/u_mult_0/mult_x_1/bimeclk_r_REG123_S1' is a constant and will be removed. (OPT-1206)
Information: The register 'u_moetop/u_imetop/u_imemap/u_imetf2_2p/u_ime_norm0/u_mult_0/mult_x_1/bimeclk_r_REG123_S1' is a constant and will be removed. (OPT-1206)
</code></pre>
<p>真相大白：<strong>默认情况下，DC会remove constant register, 并在log里给出OPT-1206提示</strong>。至此，终于找到failing root cause,下面就是针对问题找到解决方法了。DC 对constant register 的处理由以下3个变量控制，默认值都是true:</p>
<pre><code>compile_seqmap_propagate_constants:           Removes cells with a constant on the input.
compile_seqmap_propagate_high_effort:         Removes cells with a constant on the reset.
compile_seqmap_propagate_constants_size_only: Propagates constants through size_only cells.
</code></pre>
<p>其中，<code>compile_seqmap_propagate_constants_size_only</code> 是控制是否传递size_only/dont_touch attribute的constant reg 的constant value，而不是要remove size_only/dont_touch reg。</p>

<h4 id="13-slove">1.3 Slove</h4>
<p>所以，我们在compile前将这些变量设为false,问题应该就可以迎刃而解了。但是，难道我们要用没有remove constant reg的netlist做PR? 好吧，曲线救国：</p>
<ol>
  <li>set var flase, RTL—&gt; netlist1</li>
  <li>set var true,   RTL—&gt; netlist 2</li>
  <li>formality, RTL VS netlist1</li>
  <li>formality, netlist1 VS netlist2</li>
  <li>PR with netlist2</li>
</ol>

<h3 id="case2">Case2</h3>
<h4 id="21-problem">2.1 Problem</h4>
<p>综合完，RTL-Gate Formality inconclusive, 有33个points。原来这个module属于一个42bit除以9bit的除法器，每一位quotient的logic cone都很大，formality 很难比较。</p>
<pre><code>********************************* Verification Results *********************************
Verification INCONCLUSIVE
(Equivalence checking aborted due to complexity)
   ATTENTION: synopsys_auto_setup mode was enabled.
              See Synopsys Auto Setup Summary for details.
   ATTENTION: RTL interpretation messages were produced during link
              of reference design.
              Verification results may disagree with a logic simulator.
-----------------------------------------------------------------------
 Reference design: r:/WORK/***
 Implementation design: i:/WORK/***
 161129 Passing compare points
 33 Aborted compare points
 0 Unverified compare points
</code></pre>
<h4 id="22-debug">2.2 Debug</h4>
<p>前文提到的方法我都一一试过:timeout-limit, datapath-effort, new tool version, set_verification_priority, 10多种alternative strategy 都没用……
难道真的是因为这个42bit/9bit 的除法器太大了，无论如何都无法过formality?
那么仅综合这个除法器能不能过呢？我尝试把这个除法器module摘出来，仅综合这个module，然后对这个module做formal check,奇迹出现了，居然SUCCESSED.</p>
<h4 id="23-solve">2.3 Solve</h4>
<p>最终，通过优先综合除法器design，再综合其它design, 才成功pass formal check.</p>

<h2 id="conclusion">Conclusion</h2>
<p>RTL-Gate LEC check 是一项很复杂的过程，通常需要在DC/formality里迭代完成，这是非常耗时的，所以formal check 的经验在此格外重要，大牛可能一眼就看出是什么原因，需要在综合时做何种设置；而吾类菜鸟就要慢慢debug,花费大量时间尝试各种可能。文中所述仅为本人在项目中积累的粗浅经验，有错请指正。<strong>不积跬步无以至千里</strong>，不断积累，早日成大牛!</p>


            		</section>
		  
					<!-- % include share.html % -->
					<br>
					<br>
					<br>
					<!-- the previous/next page navigation -->
					<div class="PageNavigation">
					  
					    <a class="prev" href="/test-mark-syntax/"> 
							<span class="prev_next_text">
								<i class="fa fa-angle-left" aria-hidden="true"></i>上一篇
							</span>
							<br>
							test markdown syntax
						</a>
					  
					  
					</div>

		    		
<!-- Disqus Comments Start -->


  <div id="disqus_thread"></div>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


<!-- Disqus Comments End -->

				</div>
			</div>

		</section>
	</div>
	
<div id="disqus_thread"></div>
<script>
	/*var disqus_developer = 1;*/
	/**
	*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
	*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
	/*
	var disqus_config = function () {
	this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
	this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
	};
	*/
	(function() { // DON'T EDIT BELOW THIS LINE
	var d = document, s = d.createElement('script');
	s.src = 'https://ileonsun.disqus.com/embed.js';
	s.setAttribute('data-timestamp', +new Date());
	(d.head || d.body).appendChild(s);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




    <!-- Footer Start -->
<footer>

    <!-- Social Buttons Start -->

<ul class="list-inline social-buttons">
    
    <li>
		<a href="https://github.com/iLeonSun" target="_blank" >
			<i class="fa fa-github fa-fw">
			</i>
		</a>
	</li>
    
    <li>
		<a href="wechat.html" target="_blank" >
			<i class="fa fa-wechat fa-fw">
			</i>
		</a>
	</li>
    
    <li>
		<a href="mailto:liangliang_sun@163.com" target="_blank" >
			<i class="fa fa-envelope fa-fw">
			</i>
		</a>
	</li>
    
    <li>
		<a href="/feed.xml" target="_blank" >
			<i class="fa fa-rss fa-fw">
			</i>
		</a>
	</li>
    
    
</ul>

<!-- Social Buttons End -->


    <div class="container text-center">
		<p>Copyright &copy; Leon Sun 2017</p> 
        
    </div>
</footer>
<!-- Footer End -->

    
<!-- Javascript Start -->

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<!-- Plugin JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

<!-- Custom Theme JavaScript -->
<!--* Start Bootstrap - Grayscale Bootstrap Theme (http://startbootstrap.com)
* Code licensed under the Apache License v2.0.
* For details, see http://www.apache.org/licenses/LICENSE-2.0.-->
<script>
function toggleNavCollapse(){50<$(".navbar").offset().top?$(".navbar-fixed-top").addClass("top-nav-collapse"):$(".navbar-fixed-top").removeClass("top-nav-collapse");}
$(document).ready(toggleNavCollapse);
$(window).scroll(toggleNavCollapse);$(function(){$("a.page-scroll").bind("click",function(b){var a=$(this);$("html, body").stop().animate({scrollTop:$(a.attr("href")).offset().top-50},1500,"easeInOutExpo",function(){a.blur()});b.preventDefault()})});$(".navbar-collapse ul li a").click(function(){$(".navbar-toggle:visible").click()});
</script>





  <!-- Syntax highlight in post pages-->

  <!-- <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script> -->
  <script src="/js/highlight.pack.js"></script>
  <script src="/js/hignlightjs-line-numbers.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script>hljs.initLineNumbersOnLoad();</script>
  <!-- <script src="/js/prism.js"</script> -->





  <!-- Share buttons Start -->

  <script src="/js/rrssb.min.js"></script>

  <!-- Share buttons End -->





<script>
function addTohistory() {
  if (!window.location.host.startsWith("127.0.0.1")) {
    history.pushState({}, 'How to pass formal check', 'http://localhost:4000/how-to-pass-formal-check/');
  }
}
</script>

<!-- Gesture Navigation / Swipe Instruction Start -->


  

    <!-- Post Gesture Navigation Start -->

    <script type="text/javascript" src="/js/hammer.min.js"></script>

    <script>
      var post = document.getElementById('post');

      new Hammer(post).on('swipeleft', function(event) {
        addTohistory();
        
          document.location.replace("/test-mark-syntax/");
        
      });

      new Hammer(post).on('swiperight', function(event) {
        addTohistory();
        
          document.location.replace("/");
        
      });
    </script>

    <!-- Post Gesture Navigation Start -->

  

  

  

  

    <!-- Swipe Instructions for Post Start -->

    <script>
      $(document).ready(function(){
        if(!localStorage.getItem('post-swipeshowed')){
          $("#swipe-instruction").fadeIn();
          $("#swipe-instruction .close-swipe-instruction").click(function(){
            $("#swipe-instruction").fadeOut();
          });
          localStorage.setItem('post-swipeshowed', true);
        }
      });
    </script>

    <!-- Swipe Instructions for Post End -->

  

<!-- Gesture Navigation / Swipe Instruction End -->

<!-- Javascript End -->






  </body>
</html>

<!-- Post Layout End -->
